<html>
  <head>
    <title>Verovio Demo</title>
    <script type="module">
      import createVerovioModule from './dist/verovio-module.mjs';
      import { VerovioToolkit } from './dist/verovio.mjs';
      import { WorkletSynthesizer as Synthetizer, Sequencer } from 'https://cdn.jsdelivr.net/npm/spessasynth_lib@latest/+esm';

      function atoab(base64) {
        return Uint8Array.from(atob(base64), (c) => c.charCodeAt(0)).buffer;
      }

      createVerovioModule().then(async VerovioModule => {
        const verovioToolkit = new VerovioToolkit(VerovioModule);
        const score = await (await fetch('data/maqam-rast.musicxml')).text();
        verovioToolkit.loadData(score);
        verovioToolkit.setOptions({
          scale: 50,
          font: 'Bravura',
        })
        const data = verovioToolkit.renderToSVG(1);
        document.getElementById('sheet').innerHTML = data;

        fetch("data/GeneralUserGS.sf3").then(async response =>
        {
          // load the sound bank into an array buffer
          let soundfont = await response.arrayBuffer();
          document.getElementById('message').innerHTML = 'Ready to play â–¶ï¸ (Refresh the page to stop playing ðŸ˜‚)';

          // add an event listener for the file inout
          document.getElementById('message').addEventListener('click', async event =>
          {
            const midiFile = atoab(verovioToolkit.renderToMIDI());
            const context = new AudioContext();
            await context.audioWorklet.addModule('./spessasynth_processor.min.js');
            const synth = new Synthetizer(context);
            synth.connect(context.destination);
            synth.soundBankManager.addSoundBank(soundfont, 'main');
            const seq = new Sequencer(synth);
            seq.loadNewSongList([{ binary: midiFile }]);
            seq.play();
          });
        });
      });
    </script>
    <style>
      body {
        background-color: powderblue;
      }
      #message {
        cursor: pointer;
      }
      #github {
        position: absolute;
        top: 5px;
        right: 5px;
      }
    </style>
    <script async defer src="https://buttons.github.io/buttons.js"></script>
  </head>
  <body>
    <div id="github">
      <a class="github-button" href="https://github.com/infojunkie/verovio" data-size="large" aria-label="Visit infojunkie/verovio on GitHub">Visit on GitHub</a>
    </div>
    <div id="message"></div>
    <div id="sheet"></div>
  </body>
</html>
