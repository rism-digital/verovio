---
layout: verovio
verovio-light: true
title: MIDI Output
active: other-formats
other-active: midi
version-footer: true
midiplayer: true
---

<script type="text/javascript">
//<![CDATA[

    var zoom = 100;
    var pageHeight = 9000;
    var pageWidth = 1800;
    var spacingStaff = 10;
    var spacingSystem = 0;
    var border = 20;
    var adjustPageHeight = 1;
    var vrvToolkit = new verovio.toolkit();
    var ids = []

    function load_data(data) {
        options = {
                    pageHeight: pageHeight,
                    pageWidth: pageWidth,
                    adjustPageHeight: adjustPageHeight,
                    spacingStaff: spacingStaff,
                    spacingSystem: spacingSystem,
                    border: border,
                    scale: zoom
                };

        var svg = vrvToolkit.renderData( data + "\n", options );
        console.log( svg );
        $("#svg_output").html(svg);
        $( ".note" ).click(function() {
            var id = $(this).attr("id");
            var time = vrvToolkit.getTimeForElement(id);
            $("#midi-player").midiPlayer.seek(time);
        });
        
    }
    
    function play_midi() {
        var base64midi = vrvToolkit.renderToMidi();
        var song = 'data:audio/midi;base64,' + base64midi;
        $("#play-button").hide();
        $("#player").show();
        $("#player").midiPlayer.play(song);
    }
    
    var midiUpdate = function(time) {
        // (- 400 for adjustment)
        var vrvTime = Math.max(0, time - 400);
        var elementsattime = vrvToolkit.getElementsAtTime(vrvTime);
        if (elementsattime.page > 0) {
            if ((elementsattime.notes.length > 0) && (ids != elementsattime.notes)) {
                ids.forEach(function(noteid) {
                    if ($.inArray(noteid, elementsattime.notes) == -1) {
                        $("#" + noteid ).attr("fill", "#000");
                        $("#" + noteid ).attr("stroke", "#000"); 
                        //$("#" + noteid ).removeClassSVG("highlighted"); 
                    }
                });
                ids = elementsattime.notes;
                ids.forEach(function(noteid) {
                    if ($.inArray(noteid, elementsattime.notes) != -1) {
                    //console.log(noteid);
                        $("#" + noteid ).attr("fill", "#c00");
                        $("#" + noteid ).attr("stroke", "#c00");; 
                        //$("#" + noteid ).addClassSVG("highlighted"); 
                    }
                }); 
            }
        }
    }
    
    var midiStop = function() {
        ids.forEach(function(noteid) {
            $("#" + noteid ).attr("fill", "#000");
            $("#" + noteid ).attr("stroke", "#000"); 
            //$("#" + noteid ).removeClassSVG("highlighted"); 
        });
        $("#player").hide();
        $("#play-button").show();
    }
    
    $.fn.addClassSVG = function(className){
        $(this).attr('class', function(index, existingClassNames) {
            return existingClassNames + ' ' + className;
        });
        return this;
    };

    $.fn.removeClassSVG = function(className){
        $(this).attr('class', function(index, existingClassNames) {
            //var re = new RegExp(className, 'g');
            //return existingClassNames.replace(re, '');
        });
        return this;
    };

//]]>
</script>

<div class="row">
    
    <div class="col-md-3 sidebar-offcanvas" id="sidebar" role="navigation">
        <div class="panel panel-default">
            {% include other-sidebar.html %}
        </div>
    </div>
    
    <div class="col-md-9">
        <div class="panel-body">
            <h3>MIDI Output</h3>
            
            <p>
                Verovio provides a basic MIDI output feature that can be used from the command-line tool or from the JavaScript toolkit. The MIDI output can be written to a file for further processing or for building application with MIDI playback, including in online environments. However, since MIDI is not supported in web-browsers in a standard way, an additional player will be required in such cases.
            </p>
            
            <h4>The MIDI output takes into account:</h4>
            <ul class="list-style">
                <li>The sounding accidental values provided by <code>@accid.ges</code> on <code>notes</code> and <code>accid</code>.</li>
                <li>The sounding octave values provided by <code>@oct.ges</code> on <code>note</code>.</li>
                <li>Transposing instrument information provided by <code>@trans.semi</code> on <code>staffDef</code>.</li>
            </ul>
            
            <p>
                Verovio uses the <a href="https://github.com/craigsapp/midifile" target="_blank">Midifile library</a> for generating the MIDI output.
            </p>
            
            <h4>Example use</h4>
            
            <p>
                The example below uses a <a href="https://github.com/rism-ch/midi-player/" target="_blank">JavaScript MIDI player</a> that provides callback functions that allow note highlighting. Oppositely, it is also possible to click on a note for jumping in the piece.
            </p>
            
            <div style="height: 30px;">
                <p>
                    <a id="play-button" onclick="play_midi()">Play it!</a>
                </p>
                <div id="player" style="z-index: 20; position: absolute; display: none;"></div>
            </div>
            
            <div id="svg_output"></div>

            <h4>Usage</h4>
            <p>
                With the command-line tool, for generating a MIDI file with the default options, you need to do:
            </p>
            
{% highlight bash %}$ verovio -f midi -o output.midi Ahle_Jesu_meines_Herzens_Freud.mei{% endhighlight %}
            
            <p>
                With the JavaScript toolkit, the MIDI output is available throught the <code>renderToMidi()</code> method. This returns a base64-coded MIDI file as string, which can be passed to a player or made available for download.
            </p>
            
{% highlight html %}
<script type="text/javascript">
var vrvToolkit = new verovio.toolkit();
/* ... load the MEI file */
var midiFileIn64Base = vrvToolkit.renderToMidi();
</script>
{% endhighlight %}

            <h4>Future work</h4>
            <ul class="list-style">
                <li>Tempo control options</li>
                <li>Instrument type support</li>
                <li>Tie support</li>
                <li>Dynamic support</li>
            </ul>
            
        </div>
    </div>
    
</div>

<script type="text/javascript">
//<![CDATA[

    $( document ).ready(function() {
        
        // adjust the zoom for small screens
        width = $('#svg_output').width();
        if ( width < zoom * pageWidth / 100 ) {
            zoom = width * 100 / pageWidth;
        }
        
        $.get( "{{ site.baseurl }}/examples/downloads/Bach_Chorale_bwv.363.mei" , function( data ) {
            load_data(data);
        });
        
        $("#player").midiPlayer({
            color: "#c00",
            onUnpdate: midiUpdate,
            onStop: midiStop,
            width: 250
        });
    
    });
//]]>
</script>
